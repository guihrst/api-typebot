# ============================================
# Docker Compose - API Typebot com Portal Cliente
# ============================================
# 
# USO:
#   1. Copie env.example para .env e configure
#   2. Execute: docker compose up -d
#   3. Acesse: http://localhost:5000
#
# ============================================

services:
  # ==========================================
  # Aplicação Next.js
  # ==========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-typebot-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - DATABASE_URL=postgresql://typebot:typebot123@postgres:5432/api_typebot
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
      - JWT_SECRET=${JWT_SECRET:-chave-secreta-mude-isso-em-producao}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - typebot-network

  # ==========================================
  # Banco de Dados PostgreSQL
  # ==========================================
  postgres:
    image: postgres:15-alpine
    container_name: api-typebot-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=typebot
      - POSTGRES_PASSWORD=typebot123
      - POSTGRES_DB=api_typebot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Porta externa 5433 para não conflitar com outros PostgreSQL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U typebot -d api_typebot"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - typebot-network

  # ==========================================
  # Migrations (executa uma vez e para)
  # ==========================================
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-typebot-migrations
    environment:
      - DATABASE_URL=postgresql://typebot:typebot123@postgres:5432/api_typebot
    command: npx prisma migrate deploy
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - typebot-network
    restart: "no"

# ==========================================
# Volumes persistentes
# ==========================================
volumes:
  postgres_data:
    name: api_typebot_postgres_data

# ==========================================
# Rede interna
# ==========================================
networks:
  typebot-network:
    name: typebot-network
    driver: bridge
